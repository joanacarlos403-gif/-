<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”˜è‚ƒçœå¦‡å¹¼ä¿å¥é™¢-ä»‹å…¥è¡€ç®¡å¤–ç§‘ç”¨è¯åŠ©æ‰‹</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        :root { --primary: #005a96; --accent: #d32f2f; --bg: #f4f7f9; }
        body { font-family: "PingFang SC", sans-serif; background: var(--bg); margin: 0; display: flex; color: #333; }

        /* å·¦ä¾§æ§åˆ¶é¢æ¿æ ·å¼ */
        .no-print-area { 
            width: 360px; padding: 25px; background: white; height: 100vh; 
            position: fixed; left: 0; top: 0; box-shadow: 4px 0 15px rgba(0,0,0,0.05); 
            overflow-y: auto; z-index: 100; border-right: 1px solid #e0e6ed;
        }
        .form-section { margin-bottom: 20px; }
        label { font-size: 14px; color: #666; font-weight: bold; display: block; margin-bottom: 8px; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; margin-bottom: 10px; }
        
        /* è¯ç‰©é€‰æ‹©åˆ—è¡¨äº¤äº’ */
        .drug-selector-item { margin-top: 10px; padding: 12px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; transition: 0.3s; }
        .drug-checkbox { display: flex; align-items: center; font-weight: bold; color: var(--primary); }
        .dosage-input-wrapper { margin-top: 10px; display: none; }
        .dosage-input-wrapper.active { display: block; }
        .dosage-input { background: #fffde7; border: 1px solid #fdd835; margin-bottom: 0; }

        /* æŒ‰é’®æ ·å¼ */
        .btn { padding: 15px; width: 100%; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 16px; }
        .btn-print { background: var(--primary); color: white; }
        .btn-qr { background: #27ae60; color: white; box-shadow: 0 4px 10px rgba(39,174,96,0.3); }

        /* å³ä¾§ A4 é¢„è§ˆåŒº */
        .preview-container { margin-left: 360px; padding: 20px; width: calc(100% - 360px); display: flex; flex-direction: column; align-items: center; }
        .a4-page { 
            width: 210mm; min-height: 296mm; padding: 15mm; 
            background: white; margin-bottom: 20px; box-shadow: 0 0 15px rgba(0,0,0,0.1); 
            box-sizing: border-box; position: relative;
        }

        /* æ•™è‚²å•å†…éƒ¨æ’ç‰ˆ */
        .header-box { text-align: center; border-bottom: 3px solid var(--primary); margin-bottom: 20px; padding-bottom: 15px; }
        .hospital-logo { width: 220px; margin-bottom: 10px; }
        .patient-bar { display: grid; grid-template-columns: 1fr 1fr 1.5fr; background: #f0f4f8; padding: 10px 15px; margin-bottom: 20px; font-weight: bold; font-size: 15px; border-radius: 4px; }
        
        .drug-row { display: flex; align-items: flex-start; margin-bottom: 15px; padding: 15px; border: 1px solid #eee; border-radius: 8px; page-break-inside: avoid; }
        .drug-info-text { flex: 1; padding-right: 20px; }
        .drug-title { font-size: 18px; color: var(--primary); font-weight: bold; display: block; margin-bottom: 8px; border-bottom: 1px dashed #ccc; }
        .dosage-display { color: var(--accent); font-weight: bold; font-size: 16px; margin-bottom: 8px; display: inline-block; padding: 2px 8px; background: #fff5f5; border-radius: 4px; }
        .drug-text { font-size: 14px; line-height: 1.6; color: #444; white-space: pre-wrap; text-align: justify; }
        .drug-qr-box { width: 100px; text-align: center; flex-shrink: 0; font-size: 10px; color: #999; }
        .drug-qr-box img { width: 85px; height: 85px; border: 1px solid #eee; margin-bottom: 5px; }

        .footer { position: absolute; bottom: 15mm; left: 15mm; right: 15mm; border-top: 1px solid #ddd; padding-top: 15px; font-size: 12px; color: #666; }
        .sign-area { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 10px; }

        /* å¼¹çª—æ ·å¼ */
        #qr-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:1000; flex-direction:column; align-items:center; justify-content:center; color:white; }
        #qr-card { background:white; padding:25px; border-radius:15px; text-align:center; }

        /* æ‰“å°é€‚é… */
        @media print {
            .no-print-area, #qr-overlay { display: none !important; }
            .preview-container { margin: 0; padding: 0; width: 100%; }
            .a4-page { margin: 0; box-shadow: none; width: 210mm; }
            body { background: white; }
            @page { size: A4; margin: 0; }
        }
    </style>
</head>
<body>

<div class="no-print-area">
    <h3>ğŸ¥ å®£æ•™å·¥ä½œå°</h3>
    <div class="form-section">
        <label>æ‚£è€…ä¿¡æ¯</label>
        <input type="text" id="p-name" placeholder="å§“å" oninput="draw()">
        <input type="text" id="p-bed" placeholder="åºŠå·" oninput="draw()">
        <input type="text" id="p-diag" placeholder="è¯Šæ–­" oninput="draw()">
    </div>
    <div class="form-section">
        <label>å‹¾é€‰è¯å“å¹¶è¾“å…¥å‰‚é‡</label>
        <div id="selector"></div>
    </div>
    <button class="btn btn-print" onclick="window.print()">ğŸ–¨ï¸ æ‰“å°çº¸è´¨å•</button>
    <button class="btn btn-qr" onclick="generateShareQR()">ğŸ“± ç”Ÿæˆåˆ†äº«äºŒç»´ç </button>
</div>

<div class="preview-container">
    <div class="a4-page" id="main-content">
        <div class="header-box">
            <img src="hospital_logo.png" class="hospital-logo" alt="ç”˜è‚ƒçœå¦‡å¹¼ä¿å¥é™¢">
            <div style="font-size:20px; font-weight:bold; color:var(--primary);">ç”˜è‚ƒçœå¦‡å¹¼ä¿å¥é™¢ï¼ˆç”˜è‚ƒçœä¸­å¿ƒåŒ»é™¢ï¼‰</div>
            <div style="font-size:26px; font-weight:900; margin-top:10px;">æ‚£è€…ç”¨è¯æ•™è‚²æŒ‡å¯¼å•</div>
        </div>
        <div class="patient-bar">
            <span>å§“åï¼š<span id="v-name">â€”â€”</span></span>
            <span>åºŠå·ï¼š<span id="v-bed">â€”â€”</span></span>
            <span>è¯Šæ–­ï¼š<span id="v-diag">â€”â€”</span></span>
        </div>
        <div id="v-content">
            <p style="text-align:center; color:#ccc; margin-top:100px;">â† è¯·åœ¨å·¦ä¾§å½•å…¥æ•°æ®</p>
        </div>
        <div class="footer">
            <p>æç¤ºï¼šè¯·éµåŒ»å˜±æœè¯ã€‚æ‰«ç æŸ¥é˜…è¯¦æƒ…ã€‚è‹¥æœè¯åå‡ºç°çš®ç–¹ã€å‡ºè¡€ç­‰ï¼Œè¯·ç«‹å³å°±åŒ»ã€‚</p>
            <div class="sign-area">
                <span id="v-date">æ—¥æœŸï¼š2026å¹´1æœˆ30æ—¥</span>
                <div style="text-align:right; font-weight:bold;">ä»‹å…¥ä¸è¡€ç®¡å¤–ç§‘<br>è¯å­¦éƒ¨</div>
            </div>
        </div>
    </div>
</div>

<div id="qr-overlay" onclick="this.style.display='none'">
    <div id="qr-card">
        <canvas id="share-qr"></canvas>
        <p style="color:#333; font-weight:bold; margin-top:10px;">è¯·æ‚£è€…å¾®ä¿¡æ‰«ç è·å–</p>
    </div>
    <p style="margin-top:20px;">ç‚¹å‡»å±å¹•ä»»æ„å¤„å…³é—­</p>
</div>

<script>
    const drugDb = [
        { id: "riv", name: "åˆ©ä¼æ²™ç­ç‰‡", qr: "qr_rivaroxaban.png", info: "å»ºè®®å›ºå®šæ—¶é—´æœç”¨ã€‚æ³¨æ„ç›‘æµ‹æ˜¯å¦æœ‰ç‰™é¾ˆå‡ºè¡€æˆ–é»‘ä¾¿ã€‚" },
        { id: "asp", name: "é˜¿å¸åŒ¹æ—è‚ æº¶ç‰‡", qr: "qr_aspirin.png", info: "å»ºè®®é¤å‰30åˆ†é’Ÿæ•´ç‰‡åæœã€‚æ³¨æ„è§‚å¯Ÿèƒƒéƒ¨ä¸é€‚ã€‚" },
        { id: "clo", name: "ç¡«é…¸æ°¢æ°¯å¡æ ¼é›·ç‰‡", qr: "qr_clopidogrel.png", info: "æ¯æ—¥å›ºå®šæ—¶é—´æœç”¨ä¸€æ¬¡ã€‚è§‚å¯Ÿçš®ä¸‹å‡ºè¡€ç‚¹ã€‚" },
        { id: "ros", name: "ç‘èˆ’ä¼ä»–æ±€é’™ç‰‡", qr: "qr_rosuvastatin.png", info: "å»ºè®®æ™šé—´æœç”¨ã€‚è‹¥å‡ºç°ä¸æ˜è‚Œè‚‰é…¸ç—›è¯·å¤æŸ¥ã€‚" },
        { id: "ven", name: "è¿ˆä¹‹çµç‰‡", qr: "qr_venostat.png", info: "é¥­åæœç”¨ã€‚ç”¨äºæ”¹å–„é™è„‰æ›²å¼ ã€æ°´è‚¿ç—‡çŠ¶ã€‚" },
        { id: "ber", name: "è´å‰åˆ—ç´ é’ ç‰‡", qr: "qr_beraprost.png", info: "é¤åæœç”¨ã€‚æ”¹å–„å¾ªç¯ã€‚åˆç”¨å¯èƒ½æœ‰é¢œé¢æ½®çº¢ã€‚" },
        { id: "nif", name: "ç¡è‹¯åœ°å¹³æ§é‡Šç‰‡", qr: "qr_nifedipine.png", info: "å¿…é¡»æ•´ç‰‡åæœï¼Œä¸å¯æ°å¼€ã€‚å¤–å£³æ’å‡ºå±æ­£å¸¸ã€‚" },
        { id: "ato", name: "é˜¿æ‰˜ä¼ä»–æ±€é’™ç‰‡", qr: "qr_atorvastatin.png", info: "å»ºè®®ç¡å‰æœç”¨ã€‚é¿å…å¤§é‡é¥®ç”¨è¥¿æŸšæ±ã€‚" }
    ];

    function init() {
        const box = document.getElementById('selector');
        drugDb.forEach(d => {
            const div = document.createElement('div');
            div.className = 'drug-selector-item';
            div.onclick = (e) => { if(e.target.tagName !== 'INPUT') toggleDrug(d.id); };
            div.innerHTML = `<div class="drug-checkbox"><input type="checkbox" id="check-${d.id}" style="width:18px;height:18px;margin-right:10px;">${d.name}</div>
                             <div class="dosage-input-wrapper" id="wrapper-${d.id}"><input type="text" class="dosage-input" id="dose-${d.id}" placeholder="è¾“å…¥ç”¨é‡" oninput="draw()"></div>`;
            box.appendChild(div);
        });
        
        // è§£æ URL å‚æ•°é€»è¾‘
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('name')) {
            document.getElementById('p-name').value = urlParams.get('name');
            document.getElementById('p-bed').value = urlParams.get('bed');
            document.getElementById('p-diag').value = urlParams.get('diag');
            const drugs = urlParams.get('drugs');
            if(drugs) {
                drugs.split('|').forEach(item => {
                    const [id, dose] = item.split('_');
                    const ck = document.getElementById('check-'+id);
                    if(ck) {
                        ck.checked = true;
                        document.getElementById('wrapper-'+id).classList.add('active');
                        document.getElementById('dose-'+id).value = decodeURIComponent(dose);
                    }
                });
            }
            draw();
            document.querySelector('.no-print-area').style.display = 'none';
            document.querySelector('.preview-container').style.margin = '0 auto';
        }
    }

    function toggleDrug(id) {
        const ck = document.getElementById('check-'+id);
        const wr = document.getElementById('wrapper-'+id);
        ck.checked = !ck.checked;
        wr.classList.toggle('active', ck.checked);
        if(!ck.checked) document.getElementById('dose-'+id).value = '';
        draw();
    }

    function draw() {
        document.getElementById('v-name').innerText = document.getElementById('p-name').value || "â€”â€”";
        document.getElementById('v-bed').innerText = document.getElementById('p-bed').value || "â€”â€”";
        document.getElementById('v-diag').innerText = document.getElementById('p-diag').value || "â€”â€”";
        const vContent = document.getElementById('v-content');
        vContent.innerHTML = '';
        let count = 0;
        drugDb.forEach(d => {
            if(document.getElementById('check-'+d.id).checked) {
                count++;
                const dose = document.getElementById('dose-'+d.id).value;
                vContent.innerHTML += `<div class="drug-row">
                    <div class="drug-info-text">
                        <span class="drug-title">${d.name}</span>
                        <div class="dosage-display">ç”¨é‡ï¼š${dose || "æŒ‰åŒ»å˜±"}</div>
                        <div class="drug-text">${d.info}</div>
                    </div>
                    <div class="drug-qr-box"><img src="${d.qr}" onerror="this.src='https://via.placeholder.com/85?text=QR'"><br>æ‰«ç çœ‹å®£æ•™</div>
                </div>`;
            }
        });
        if(count === 0) vContent.innerHTML = '<p style="text-align:center; color:#ccc; margin-top:100px;">â† è¯·å½•å…¥æ•°æ®</p>';
    }

    function generateShareQR() {
        document.getElementById('qr-overlay').style.display = 'flex';
        const name = document.getElementById('p-name').value;
        const bed = document.getElementById('p-bed').value;
        const diag = document.getElementById('p-diag').value;
        let drugParams = [];
        drugDb.forEach(d => {
            if(document.getElementById('check-'+d.id).checked) {
                const dose = encodeURIComponent(document.getElementById('dose-'+d.id).value || "æŒ‰åŒ»å˜±");
                drugParams.push(`${d.id}_${dose}`);
            }
        });
        const baseUrl = window.location.origin + window.location.pathname;
        const shareUrl = `${baseUrl}?name=${encodeURIComponent(name)}&bed=${encodeURIComponent(bed)}&diag=${encodeURIComponent(diag)}&drugs=${drugParams.join('|')}`;
        new QRious({ element: document.getElementById('share-qr'), value: shareUrl, size: 250, level: 'H' });
    }

    init();
</script>
</body>
</html>

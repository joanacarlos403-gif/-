<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <meta charset="UTF-8">
    <title>ç”˜è‚ƒçœå¦‡å¹¼ä¿å¥é™¢-ä»‹å…¥ä¸è¡€ç®¡å¤–ç§‘ç”¨è¯åŠ©æ‰‹</title>
    <style>
        /* æ ¸å¿ƒç¾åŒ–å˜é‡ */
        :root { 
            --primary: #005a96; 
            --primary-light: #e6f0f7;
            --accent: #d32f2f; 
            --text-main: #2c3e50;
            --bg-side: #ffffff;
            --bg-main: #f4f7f9;
        }

        body { font-family: "PingFang SC", "Microsoft YaHei", sans-serif; background: var(--bg-main); margin: 0; display: flex; color: var(--text-main); }

        /* å·¦ä¾§æ§åˆ¶å°ç¾åŒ– */
        .no-print-area { 
            width: 380px; padding: 25px; background: var(--bg-side); height: 100vh; 
            position: fixed; left: 0; top: 0; box-shadow: 4px 0 15px rgba(0,0,0,0.05); 
            overflow-y: auto; z-index: 100; border-right: 1px solid #e0e6ed;
        }
        h3 { color: var(--primary); margin-top: 0; font-size: 20px; border-left: 4px solid var(--primary); padding-left: 10px; }
        .form-section { margin-bottom: 25px; }
        label { font-size: 14px; color: #556677; font-weight: 600; display: block; margin-bottom: 8px; }
        input { 
            width: 100%; padding: 12px; border: 1px solid #dcdfe6; border-radius: 8px; 
            box-sizing: border-box; font-size: 14px; transition: all 0.3s;
        }
        input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(0,90,150,0.1); }
        
        /* è¯ç‰©åˆ—è¡¨äº¤äº’ç¾åŒ– */
        .drug-selector-item { 
            margin-top: 12px; padding: 15px; background: #ffffff; border: 1px solid #eef2f6; 
            border-radius: 10px; transition: all 0.2s; cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .drug-selector-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .drug-checkbox { display: flex; align-items: center; font-weight: bold; color: var(--primary); font-size: 15px; }
        .dosage-input-wrapper { margin-top: 12px; display: none; }
        .dosage-input-wrapper.active { display: block; animation: slideDown 0.3s ease-out; }
        .dosage-input { background: #fffcf0; border: 1px solid #f9e1a0; color: #856404; }

        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* æ‰“å°æŒ‰é’® */
        .btn-print { 
            background: linear-gradient(135deg, var(--primary), #007bbd); color:white; border:none; 
            padding: 16px; width:100%; border-radius:10px; cursor:pointer; font-weight:bold; 
            font-size:16px; margin-top: 20px; box-shadow: 0 4px 15px rgba(0,90,150,0.3); transition: 0.3s;
        }
        .btn-print:hover { opacity: 0.9; transform: scale(1.02); }

        /* å³ä¾§ A4 çº¸æ¨¡æ‹Ÿ */
        .preview-container { margin-left: 380px; padding: 40px; width: calc(100% - 380px); display: flex; flex-direction: column; align-items: center; }
        .a4-page { 
            width: 210mm; min-height: 296mm; padding: 20mm 15mm; 
            background: white; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); 
            box-sizing: border-box; position: relative; border-radius: 2px;
        }

        /* æ•™è‚²å•æ’ç‰ˆç¾åŒ– */
        .header-box { text-align: center; border-bottom: 3px solid var(--primary); margin-bottom: 25px; padding-bottom: 15px; }
        .hospital-logo { width: 220px; margin-bottom: 12px; }
        .hospital-name { font-size: 22px; font-weight: bold; color: var(--primary); margin: 0; }
        .doc-title { font-size: 28px; font-weight: 900; color: #333; margin: 12px 0; letter-spacing: 4px; }

        .patient-bar { 
            display: grid; grid-template-columns: 1.2fr 1.5fr 2fr; gap: 10px;
            background: #f8fbfc; padding: 12px 20px; margin-bottom: 25px; 
            font-weight: bold; font-size: 15px; border: 1px solid #e1e9ef; border-radius: 6px; 
        }
        
        .drug-row { 
            display: flex; align-items: flex-start; margin-bottom: 20px; 
            padding: 20px; border: 1px solid #edf2f7; border-radius: 12px;
            background: #ffffff; page-break-inside: avoid;
        }
        .drug-info-text { flex: 1; padding-right: 25px; }
        .drug-title { font-size: 19px; color: var(--primary); font-weight: bold; margin-bottom: 12px; display: flex; align-items: center; }
        .drug-title::before { content: ""; width: 4px; height: 18px; background: var(--primary); margin-right: 10px; border-radius: 2px; }
        
        .dosage-display { 
            color: var(--accent); font-weight: bold; font-size: 16px; margin-bottom: 12px; 
            padding: 6px 12px; background: #fff5f5; display: inline-block; border-radius: 6px; border-left: 4px solid var(--accent);
        }
        .drug-text { font-size: 14.5px; line-height: 1.7; color: #4a5568; white-space: pre-wrap; text-align: justify; }
        
        .drug-qr-box { width: 110px; text-align: center; flex-shrink: 0; background: #fafbfc; border-radius: 8px; padding: 10px; }
        .drug-qr-box img { width: 90px; height: 90px; mix-blend-mode: multiply; }
        .qr-hint { font-size: 11px; color: #a0aec0; margin-top: 8px; font-weight: 500; }

        .footer { position: absolute; bottom: 15mm; left: 15mm; right: 15mm; border-top: 1px solid #e2e8f0; padding-top: 15px; font-size: 12px; color: #718096; }
        .sign-area { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 20px; }
        .sign-dept { font-weight: bold; font-size: 15px; color: #2d3748; line-height: 1.4; text-align: right; }

        /* æ‰“å°é€‚é… */
        @media print {
            .no-print-area { display: none; }
            .preview-container { margin: 0; padding: 0; width: 100%; }
            .a4-page { margin: 0; box-shadow: none; width: 210mm; min-height: 297mm; padding: 15mm; }
            body { background: white; }
            .drug-row { border: 1px solid #eee; }
            @page { size: A4; margin: 0; }
        }
    </style>
</head>
<body>

<div class="no-print-area">
    <h3>ğŸ¥ å®£æ•™å½•å…¥å·¥ä½œå°</h3>
    
    <div class="form-section">
        <label>ç¬¬ä¸€æ­¥ï¼šå¡«å†™æ‚£è€…åŸºæœ¬ä¿¡æ¯</label>
        <input type="text" id="p-name" placeholder="æ‚£è€…å§“å" oninput="draw()">
        <div style="margin-top:10px;"></div>
        <input type="text" id="p-bed" placeholder="åºŠå· / ä½é™¢å·" oninput="draw()">
        <div style="margin-top:10px;"></div>
        <input type="text" id="p-diag" placeholder="ä¸´åºŠè¯Šæ–­ (å¦‚ï¼šä¸‹è‚¢é™è„‰æ›²å¼ )" oninput="draw()">
    </div>

    <div class="form-section">
        <label>ç¬¬äºŒæ­¥ï¼šå‹¾é€‰è¯å“å¹¶æ ¸å¯¹å‰‚é‡</label>
        <div id="selector"></div>
    </div>

    <button class="btn-print" onclick="window.print()">âœ¨ ç”Ÿæˆå¹¶æ‰“å°æŒ‡å¯¼å•</button>
</div>

<div class="preview-container">
    <div class="a4-page" id="main-content">
        <div class="header-box">
            <img src="hospital_logo.png" class="hospital-logo" alt="ç”˜è‚ƒçœå¦‡å¹¼ä¿å¥é™¢ Logo">
            <div class="hospital-name">ç”˜è‚ƒçœå¦‡å¹¼ä¿å¥é™¢ï¼ˆç”˜è‚ƒçœä¸­å¿ƒåŒ»é™¢ï¼‰</div>
            <div class="doc-title">æ‚£è€…ç”¨è¯æ•™è‚²æŒ‡å¯¼å•</div>
        </div>

        <div class="patient-bar">
            <span>å§“åï¼š<span id="v-name">â€”â€”</span></span>
            <span>åºŠå·ï¼š<span id="v-bed">â€”â€”</span></span>
            <span>è¯Šæ–­ï¼š<span id="v-diag">â€”â€”</span></span>
        </div>

        <div id="v-content">
            <div style="text-align:center; color:#cbd5e0; margin-top:120px;">
                <p style="font-size: 48px; margin:0;">ğŸ“</p>
                <p style="font-size: 18px;">è¯·åœ¨å·¦ä¾§å·¥ä½œå°å¼€å§‹å½•å…¥æ•°æ®</p>
            </div>
        </div>

        <div class="footer">
            <p><b>æ¸©é¦¨æç¤ºï¼š</b>è¯·ä¸¥æ ¼éµåŒ»å˜±æœè¯ï¼Œä¸å¯æ“…è‡ªåœè¯æˆ–æ›´æ”¹å‰‚é‡ã€‚æ‰«ç å¯æŸ¥é˜…è¯¥è¯ç‰©çš„è§†å¬åŒ–æ•™è‚²èµ„æ–™ã€‚è‹¥æœè¯æœŸé—´å‡ºç°çš®ç–¹ã€å‰§çƒˆå¤´ç—›ã€é»‘ä¾¿ã€è¡€å°¿æˆ–ç‰™é¾ˆå‡ºè¡€ä¸æ­¢ï¼Œè¯·ç«‹å³å‘ŠçŸ¥åŒ»ç”Ÿæˆ–å°±åŒ»ã€‚</p>
            <div class="sign-area">
                <span id="print-date">æ‰“å°æ—¥æœŸï¼š2026å¹´1æœˆ30æ—¥</span>
                <div class="sign-dept">
                    ä»‹å…¥ä¸è¡€ç®¡å¤–ç§‘<br>
                    è¯å­¦éƒ¨
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // è¯å“æ•°æ®åº“
    const drugDb = [
        { id: "riv", name: "åˆ©ä¼æ²™ç­ç‰‡", qr: "qr_rivaroxaban.png", info: "ã€æŒ‡å¯¼ã€‘ï¼šå»ºè®®æ¯æ—¥å›ºå®šæ—¶é—´æœç”¨ã€‚æ³¨æ„ç›‘æµ‹æ˜¯å¦æœ‰ç‰™é¾ˆå‡ºè¡€ã€çš®è‚¤é’ç´«ç˜€æ–‘æˆ–æŸæ²¹æ ·é»‘ä¾¿ã€‚å›´æ‰‹æœ¯æœŸåœè¯è¯·åŠ¡å¿…å’¨è¯¢ä¸»æ²»åŒ»å¸ˆã€‚" },
        { id: "asp", name: "é˜¿å¸åŒ¹æ—è‚ æº¶ç‰‡", qr: "qr_aspirin.png", info: "ã€æŒ‡å¯¼ã€‘ï¼šå»ºè®®é¤å‰30åˆ†é’Ÿæ•´ç‰‡åæœï¼Œå‡å°‘å¯¹èƒƒç²˜è†œåˆºæ¿€ã€‚æ³¨æ„è§‚å¯Ÿæ˜¯å¦æœ‰èƒƒç—›ã€ç‰™é¾ˆå‡ºè¡€ã€‚å¦‚æœ‰æ‰‹æœ¯è®¡åˆ’è¯·æå‰5-7å¤©å‘ŠçŸ¥åŒ»ç”Ÿã€‚" },
        { id: "clo", name: "ç¡«é…¸æ°¢æ°¯å¡æ ¼é›·ç‰‡", qr: "qr_clopidogrel.png", info: "ã€æŒ‡å¯¼ã€‘ï¼šæ¯æ—¥å›ºå®šæ—¶é—´æœç”¨ä¸€æ¬¡ã€‚ä½œä¸ºæŠ—è¡€å°æ¿è¯ç‰©ï¼Œè¯·æ³¨æ„é¢„é˜²ç£•ç¢°ï¼Œè§‚å¯Ÿçš®ä¸‹æ˜¯å¦æœ‰å‡ºè¡€ç‚¹ã€‚ä¸è¦æ“…è‡ªè”ç”¨å…¶ä»–æ¶ˆç‚æ­¢ç—›è¯ã€‚" },
        { id: "ros", name: "ç‘èˆ’ä¼ä»–æ±€é’™ç‰‡", qr: "qr_rosuvastatin.png", info: "ã€æŒ‡å¯¼ã€‘ï¼šå»ºè®®æ™šé—´æœç”¨æ•ˆæœæ›´ä½³ã€‚è‹¥ç”¨è¯æœŸé—´å‡ºç°ä¸æ˜åŸå› çš„è‚Œè‚‰ç–¼ç—›ã€ä¹åŠ›æˆ–å°¿æ¶²é¢œè‰²åŠ æ·±ï¼Œè¯·åŠæ—¶å°±è¯Šæ£€æŸ¥è‚åŠŸä¸è‚Œé…¸æ¿€é…¶ã€‚" },
        { id: "ven", name: "è¿ˆä¹‹çµç‰‡", qr: "qr_venostat.png", info: "ã€æŒ‡å¯¼ã€‘ï¼šå»ºè®®é¥­åæœç”¨ã€‚ä¸»è¦ç”¨äºæ”¹å–„é™è„‰æ›²å¼ ã€æ…¢æ€§é™è„‰åŠŸèƒ½ä¸å…¨å¼•èµ·çš„æ°´è‚¿ã€çš®ç‚ã€ç–¼ç—›ç­‰ç—‡çŠ¶ã€‚" },
        { id: "ber", name: "è´å‰åˆ—ç´ é’ ç‰‡", qr: "qr_beraprost.png", info: "ã€æŒ‡å¯¼ã€‘ï¼šé¤åæœç”¨ã€‚æ”¹å–„æ…¢æ€§åŠ¨è„‰é—­å¡æ€§ç–¾ç—…å¼•èµ·çš„è‚¢ä½“æºƒç–¡ä¸ç–¼ç—›ã€‚å°‘æ•°æ‚£è€…åˆç”¨å¯èƒ½å‡ºç°é¢éƒ¨æ½®çº¢æˆ–å¤´ç—›ã€‚" },
        { id: "nif", name: "ç¡è‹¯åœ°å¹³æ§é‡Šç‰‡", qr: "qr_nifedipine.png", info: "ã€æŒ‡å¯¼ã€‘ï¼šå¿…é¡»æ•´ç‰‡åæœï¼Œä¸å¯åš¼ç¢æˆ–æ°å¼€ï¼å¦åˆ™ä¼šå¯¼è‡´è¡€å‹æ³¢åŠ¨è¿‡å¤§ã€‚è¯ç‰‡å¤–å£³ä¸è¢«å¸æ”¶å±äºæ­£å¸¸ç°è±¡ã€‚" },
        { id: "ato", name: "é˜¿æ‰˜ä¼ä»–æ±€é’™ç‰‡", qr: "qr_atorvastatin.png", info: "ã€æŒ‡å¯¼ã€‘ï¼šå»ºè®®ç¡å‰æœç”¨ã€‚é¥®é£Ÿåº”ä¿æŒä½è„‚ä½èƒ†å›ºé†‡ã€‚é¿å…å¤§é‡é¥®ç”¨è¥¿æŸšæ±ï¼Œä»¥å…å¢åŠ è¯ç‰©å‰¯ä½œç”¨é£é™©ã€‚" }
    ];

    function init() {
        const box = document.getElementById('selector');
        drugDb.forEach(d => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'drug-selector-item';
            itemDiv.onclick = (e) => {
                if(e.target.tagName !== 'INPUT') toggleDrug(d.id);
            };
            itemDiv.innerHTML = `
                <div class="drug-checkbox">
                    <input type="checkbox" id="check-${d.id}" style="width:20px; height:20px; margin-right:12px;">
                    ${d.name}
                </div>
                <div class="dosage-input-wrapper" id="wrapper-${d.id}">
                    <input type="text" class="dosage-input" id="dose-${d.id}" 
                           placeholder="è¾“å…¥å‰‚é‡ï¼ˆå¦‚ï¼š15mg qdï¼‰" oninput="draw()">
                </div>
            `;
            box.appendChild(itemDiv);
        });
        
        // è®¾ç½®å½“å‰æ—¥æœŸ
        const today = new Date();
        document.getElementById('print-date').innerText = `æ‰“å°æ—¥æœŸï¼š${today.getFullYear()}å¹´${today.getMonth()+1}æœˆ${today.getDate()}æ—¥`;
    }

    function toggleDrug(id) {
        const check = document.getElementById('check-' + id);
        const wrapper = document.getElementById('wrapper-' + id);
        check.checked = !check.checked;
        if(check.checked) {
            wrapper.classList.add('active');
        } else {
            wrapper.classList.remove('active');
            document.getElementById('dose-' + id).value = '';
        }
        draw();
    }

    function draw() {
        // åŒæ­¥åŸºæœ¬ä¿¡æ¯
        document.getElementById('v-name').innerText = document.getElementById('p-name').value || "â€”â€”";
        document.getElementById('v-bed').innerText = document.getElementById('p-bed').value || "â€”â€”";
        document.getElementById('v-diag').innerText = document.getElementById('p-diag').value || "â€”â€”";
        
        const content = document.getElementById('v-content');
        content.innerHTML = '';
        
        let hasSelection = false;
        drugDb.forEach(d => {
            if(document.getElementById('check-' + d.id).checked) {
                hasSelection = true;
                const dose = document.getElementById('dose-' + d.id).value;
                const row = document.createElement('div');
                row.className = 'drug-row';
                row.innerHTML = `
                    <div class="drug-info-text">
                        <span class="drug-title">${d.name}</span>
                        <div class="dosage-display">ä¸ªæ€§åŒ–ç”¨æ³•ï¼š${dose || "éµåŒ»å˜±æ‰§è¡Œ"}</div>
                        <div class="drug-text">${d.info}</div>
                    </div>
                    <div class="drug-qr-box">
                        <img src="${d.qr}" onerror="this.src='https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=è¯ç‰©æ•™è‚²è¯¦æƒ…'">
                        <div class="qr-hint">æ‰«ç çœ‹è¯¦æƒ…</div>
                    </div>
                `;
                content.appendChild(row);
            }
        });
        if(!hasSelection) {
            content.innerHTML = '<div style="text-align:center; color:#cbd5e0; margin-top:120px;"><p style="font-size: 48px; margin:0;">ğŸ“</p><p style="font-size: 18px;">è¯·åœ¨å·¦ä¾§å·¥ä½œå°å¼€å§‹å½•å…¥æ•°æ®</p></div>';
        }
    }

    init();
    function generateShareQR() {
    // 1. å¼¹å‡ºé®ç½©å±‚ï¼ˆç¡®ä¿ä½ HTMLé‡Œæœ‰idä¸ºqr-overlayçš„divï¼‰
    const overlay = document.getElementById('qr-overlay');
    if (!overlay) {
        alert("è¯·æ£€æŸ¥HTMLä¸­æ˜¯å¦å·²æ·»åŠ qr-overlayå¼¹çª—ä»£ç ");
        return;
    }
    overlay.style.display = 'flex';

    // 2. é‡‡é›†æ‚£è€…åŸºæœ¬ä¿¡æ¯
    const name = document.getElementById('p-name').value;
    const bed = document.getElementById('p-bed').value;
    const diag = document.getElementById('p-diag').value;
    
    // 3. é‡‡é›†é€‰ä¸­çš„è¯å“åŠæ‰‹åŠ¨è¾“å…¥çš„å‰‚é‡
    let drugParams = [];
    // æ³¨æ„ï¼šè¿™é‡Œçš„ drugDb å¿…é¡»å¯¹åº”ä½ å®šä¹‰çš„è¯å“æ•°æ®å¯¹è±¡
    drugDb.forEach(d => {
        const check = document.getElementById('check-' + d.id);
        const doseInput = document.getElementById('dose-' + d.id);
        // å¦‚æœå‹¾é€‰äº†è¯¥è¯ï¼Œåˆ™è®°å½• ID å’Œ å‰‚é‡
        if (check && check.checked) {
            const dose = encodeURIComponent(doseInput.value || "æŒ‰åŒ»å˜±");
            drugParams.push(`${d.id}_${dose}`);
        }
    });

    // 4. æ„å»ºå¸¦å‚æ•°çš„ä¸“å± URL
    // æ ¼å¼å¦‚ï¼šhttps://xxx.github.io/med-edu/?name=å¼ ä¸‰&bed=01&diag=æ›²å¼ &drugs=riv_10mg|ato_20mg
    const baseUrl = window.location.origin + window.location.pathname;
    const shareUrl = `${baseUrl}?name=${encodeURIComponent(name)}&bed=${encodeURIComponent(bed)}&diag=${encodeURIComponent(diag)}&drugs=${drugParams.join('|')}`;

    // 5. è°ƒç”¨ QRious åº“ç»˜åˆ¶äºŒç»´ç 
    // è¿™é‡Œçš„ share-qr å¯¹åº” HTML ä¸­çš„ canvas æ ‡ç­¾
    new QRious({
        element: document.getElementById('share-qr'),
        value: shareUrl,
        size: 280,
        level: 'H' // é«˜çº é”™çº§åˆ«ï¼Œé˜²æ­¢æŠ˜å°„å¯¼è‡´æ— æ³•æ‰«æ
    });
}
</script>
<div id="qr-overlay" onclick="this.style.display='none'" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:1000; flex-direction:column; align-items:center; justify-content:center; color:white;">
    <div style="background:white; padding:20px; border-radius:15px; margin-bottom:20px;">
        <canvas id="share-qr"></canvas>
    </div>
    <p style="font-size:18px; font-weight:bold;">è¯·æ‚£è€…å¾®ä¿¡â€œæ‰«ä¸€æ‰«â€</p>
    <p style="font-size:14px; opacity:0.8;">æ‰«æåå†…å®¹å°†è‡ªåŠ¨åŒæ­¥è‡³æ‚£è€…æ‰‹æœº</p>
    <p style="font-size:12px; margin-top:10px;">(ç‚¹å‡»ç©ºç™½å¤„å…³é—­é¢„è§ˆ)</p>
</div>
</body>
</html>
// é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ‰§è¡Œ
window.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    
    // æ£€æŸ¥ç½‘å€é‡Œæ˜¯å¦æœ‰â€œnameâ€è¿™ä¸ªå‚æ•°
    if (urlParams.has('name')) {
        // 1. è‡ªåŠ¨å¡«å……åŸºæœ¬ä¿¡æ¯
        document.getElementById('p-name').value = urlParams.get('name');
        document.getElementById('p-bed').value = urlParams.get('bed');
        document.getElementById('p-diag').value = urlParams.get('diag');
        
        // 2. è‡ªåŠ¨å‹¾é€‰è¯å“å¹¶å¡«å……å‰‚é‡
        const drugsData = urlParams.get('drugs');
        if (drugsData) {
            const items = drugsData.split('|');
            items.forEach(item => {
                const [id, dose] = item.split('_');
                const check = document.getElementById('check-' + id);
                if (check) {
                    check.checked = true;
                    // è§¦å‘ç•Œé¢æ˜¾ç¤ºé€»è¾‘
                    document.getElementById('wrapper-' + id).classList.add('active');
                    document.getElementById('dose-' + id).value = decodeURIComponent(dose);
                }
            });
        }
        
        // 3. æ¸²æŸ“å‡ºå®£æ•™å•å¹¶éšè—è¯å¸ˆçš„å·¦ä¾§æ§åˆ¶æ 
        draw(); 
        document.querySelector('.no-print-area').style.display = 'none';
        document.querySelector('.preview-container').style.margin = '0 auto';
        document.title = "æ‚¨çš„ç”¨è¯æ•™è‚²æŒ‡å¯¼å•";
    }
});
